pipeline {
    environment {
        DOCKER_ID = "ngocksam"
        IMAGE_NAME = "backend"
        IMAGE_TAG = "${BUILD_NUMBER}"
    }
    agent any
    stages{
        stage('Cloner le code source') {
            steps {
                script {
                    sh '''
                        git clone git@github.com:ngocksam/backend.git
                    '''
                }
            }
        }
        stage ('Build de notre Image Docker'){
            steps {
                script {
                    sh '''
                        cd backend
                        docker build -t $DOCKER_ID/$IMAGE_NAME:$IMAGE_TAG .
                        cd ..
                        rm -Rf backend
                    '''
                }
            }
        }
        stage ('Docker Push sur dockerhub'){
            steps {
                script {
                    sh '''
                        docker login -u $DOCKER_ID -p $DOCKER_PASSWORD
                        docker push $DOCKER_ID/$IMAGE_NAME:$IMAGE_TAG
                        docker rmi $DOCKER_ID/$IMAGE_NAME:$IMAGE_TAG
                    '''
                }
            }
        }
        stage('Mise à Jour des manifests pour ARGO') {
            steps {
                script {
                    sh '''
                        git clone git@github.com:ngocksam/deployment-${IMAGE_NAME}.git
                        cd deployment-${IMAGE_NAME}
                        rm -Rf .git
                        git init
                        git config user.email ngocksam@gmail.com
                        git config user.name ngocksam
                        cat values.yaml
                        sed -i 's+tag.*+tag: "${IMAGE_TAG}"+g' values.yaml
                        cat values.yaml
                        git add .
                        git remote add origin git@github.com:ngocksam/deployment-${IMAGE_NAME}.git
                        git commit -m "Valeur de l'image mise à jour par Jenkins: ${IMAGE_TAG}"
                        git push origin master
                        cd ..
                        rm -Rf deployment-${IMAGE_NAME}
                    '''
                }
            }
        }
    }
}
